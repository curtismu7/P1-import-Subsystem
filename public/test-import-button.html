<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Button Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .btn { padding: 10px 20px; margin: 10px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; border: none; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .file-info { margin: 10px 0; padding: 10px; background: #f8f9fa; }
        select, input[type="file"] { margin: 10px; padding: 5px; }
    </style>
</head>
<body>
    <h1>Import Button Validation Test</h1>
    
    <div class="test-section">
        <h2>Test Import Button State</h2>
        
        <div>
            <label>Select CSV File:</label>
            <input type="file" id="csv-file" accept=".csv">
            <div id="file-info" class="file-info" style="display: none;"></div>
        </div>
        
        <div>
            <label>Select Population:</label>
            <select id="import-population-select">
                <option value="">Select a population</option>
                <option value="test-pop-1">Test Population 1</option>
                <option value="test-pop-2">Test Population 2</option>
                <option value="sample-users">Sample Users</option>
            </select>
        </div>
        
        <div>
            <button id="start-import" class="btn btn-primary" disabled>Start Import</button>
        </div>
        
        <div>
            <h3>Current State:</h3>
            <div id="state-display">
                <p>File Selected: <span id="file-status">No</span></p>
                <p>Population Selected: <span id="population-status">No</span></p>
                <p>Button Enabled: <span id="button-status">No</span></p>
            </div>
        </div>
        
        <div>
            <button onclick="testValidation()" class="btn">Test Validation Function</button>
            <button onclick="simulateFileSelect()" class="btn">Simulate File Select</button>
            <button onclick="clearAll()" class="btn">Clear All</button>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Console Output</h2>
        <div id="console-output" style="background: #000; color: #0f0; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace;"></div>
    </div>

    <script>
        // Mock objects for testing
        let selectedFile = null;
        
        // Mock SafeDOM and ErrorHandler
        window.safeDOM = {
            selectById: (id) => document.getElementById(id),
            addClass: (el, cls) => el?.classList.add(cls),
            removeClass: (el, cls) => el?.classList.remove(cls)
        };
        
        window.errorHandler = {
            wrapSync: (fn) => fn
        };
        
        window.UI_CONFIG = {
            SELECTORS: {
                START_IMPORT_BTN: 'start-import',
                IMPORT_POPULATION_SELECT: 'import-population-select'
            },
            CLASSES: {
                BTN_DISABLED: 'btn-disabled',
                BTN_PRIMARY: 'btn-primary'
            }
        };
        
        // Console output capture
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            consoleOutput.innerHTML += args.join(' ') + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        // Import validation function (copied from import-subsystem.js)
        function validateAndUpdateButtonState() {
            console.log('üîç [VALIDATION] validateAndUpdateButtonState called');
            
            const safeDOM = window.safeDOM;
            const errorHandler = window.errorHandler;
            const UI_CONFIG = window.UI_CONFIG;
            
            console.log('üîç [VALIDATION] UI_CONFIG:', UI_CONFIG);
            
            errorHandler.wrapSync(() => {
                console.log('üîç [VALIDATION] Inside error handler wrapper');
                
                const importBtn = safeDOM.selectById(UI_CONFIG.SELECTORS.START_IMPORT_BTN);
                console.log('üîç [VALIDATION] Import button found:', !!importBtn, importBtn);
                
                if (!importBtn) {
                    console.log('‚ùå [VALIDATION] Import button not found, exiting');
                    return;
                }
                
                // Check if file is selected
                const hasFile = !!selectedFile;
                console.log('üîç [VALIDATION] File check:', { hasFile, selectedFile: selectedFile?.name });
                
                // Check if population is selected
                const populationSelect = safeDOM.selectById(UI_CONFIG.SELECTORS.IMPORT_POPULATION_SELECT);
                console.log('üîç [VALIDATION] Population select found:', !!populationSelect, populationSelect);
                
                const hasPopulation = populationSelect && populationSelect.value && populationSelect.value !== '';
                console.log('üîç [VALIDATION] Population check:', { 
                    hasPopulation, 
                    value: populationSelect?.value,
                    selectedText: populationSelect?.selectedOptions?.[0]?.text
                });
                
                // Enable button only if both file and population are selected
                const shouldEnable = hasFile && hasPopulation;
                console.log('üîç [VALIDATION] Final validation:', { hasFile, hasPopulation, shouldEnable });
                
                importBtn.disabled = !shouldEnable;
                console.log('üîç [VALIDATION] Button disabled set to:', importBtn.disabled);
                
                // Update button appearance
                if (shouldEnable) {
                    console.log('üîç [VALIDATION] Enabling button - removing disabled class, adding primary');
                    safeDOM.removeClass(importBtn, UI_CONFIG.CLASSES.BTN_DISABLED);
                    safeDOM.addClass(importBtn, UI_CONFIG.CLASSES.BTN_PRIMARY);
                } else {
                    console.log('üîç [VALIDATION] Disabling button - adding disabled class, removing primary');
                    safeDOM.addClass(importBtn, UI_CONFIG.CLASSES.BTN_DISABLED);
                    safeDOM.removeClass(importBtn, UI_CONFIG.CLASSES.BTN_PRIMARY);
                }
                
                console.log('üîç [VALIDATION] Button final state:', {
                    disabled: importBtn.disabled,
                    classList: importBtn.classList.toString()
                });
                
                updateStateDisplay();
            })();
        }
        
        function updateStateDisplay() {
            document.getElementById('file-status').textContent = selectedFile ? 'Yes (' + selectedFile.name + ')' : 'No';
            
            const populationSelect = document.getElementById('import-population-select');
            const hasPopulation = populationSelect.value && populationSelect.value !== '';
            document.getElementById('population-status').textContent = hasPopulation ? 'Yes (' + populationSelect.value + ')' : 'No';
            
            const importBtn = document.getElementById('start-import');
            document.getElementById('button-status').textContent = importBtn.disabled ? 'No' : 'Yes';
        }
        
        function testValidation() {
            console.log('=== MANUAL VALIDATION TEST ===');
            validateAndUpdateButtonState();
        }
        
        function simulateFileSelect() {
            selectedFile = { name: 'test-users.csv', size: 1024, type: 'text/csv' };
            console.log('=== SIMULATED FILE SELECT ===');
            console.log('File selected:', selectedFile);
            
            const fileInfo = document.getElementById('file-info');
            fileInfo.innerHTML = `<strong>File:</strong> ${selectedFile.name} (${selectedFile.size} bytes)`;
            fileInfo.style.display = 'block';
            
            validateAndUpdateButtonState();
        }
        
        function clearAll() {
            selectedFile = null;
            document.getElementById('csv-file').value = '';
            document.getElementById('import-population-select').value = '';
            document.getElementById('file-info').style.display = 'none';
            console.log('=== CLEARED ALL ===');
            validateAndUpdateButtonState();
        }
        
        // Event listeners
        document.getElementById('csv-file').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                selectedFile = e.target.files[0];
                console.log('=== FILE INPUT CHANGE ===');
                console.log('File selected via input:', selectedFile);
                
                const fileInfo = document.getElementById('file-info');
                fileInfo.innerHTML = `<strong>File:</strong> ${selectedFile.name} (${selectedFile.size} bytes)`;
                fileInfo.style.display = 'block';
                
                validateAndUpdateButtonState();
            }
        });
        
        document.getElementById('import-population-select').addEventListener('change', function(e) {
            console.log('=== POPULATION SELECT CHANGE ===');
            console.log('Population selected:', e.target.value);
            validateAndUpdateButtonState();
        });
        
        // Initial state
        console.log('=== IMPORT BUTTON TEST INITIALIZED ===');
        updateStateDisplay();
    </script>
</body>
</html>
