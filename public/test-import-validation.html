<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Import Validation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
            background: #e9ecef;
        }
        #console-output {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Import Validation Testing Tool</h1>
        
        <div class="status">
            <strong>Purpose:</strong> Test the import button validation logic and check current state.
        </div>
        
        <div class="test-section">
            <h3>Import Button State Tests:</h3>
            <button class="btn-primary" onclick="checkButtonState()">Check Start Import Button State</button>
            <button class="btn-secondary" onclick="checkFileSelection()">Check File Selection</button>
            <button class="btn-success" onclick="checkPopulationSelection()">Check Population Selection</button>
            <button class="btn-warning" onclick="triggerValidation()">Trigger Validation Function</button>
        </div>
        
        <div class="test-section">
            <h3>Simulate User Actions:</h3>
            <button class="btn-primary" onclick="simulateFileSelect()">Simulate File Selection</button>
            <button class="btn-primary" onclick="simulatePopulationSelect()">Simulate Population Selection</button>
            <button class="btn-success" onclick="simulateBothSelections()">Simulate Both Selections</button>
            <button class="btn-secondary" onclick="clearSelections()">Clear All Selections</button>
        </div>
        
        <div class="test-section">
            <h3>Direct Element Access:</h3>
            <button class="btn-warning" onclick="accessMainAppElements()">Access Main App Elements</button>
            <button class="btn-warning" onclick="injectValidationTest()">Inject Validation Test</button>
        </div>
        
        <div>
            <h3>Console Output:</h3>
            <div id="console-output">Import validation testing tool initialized...\n</div>
        </div>
    </div>

    <script>
        // Console output capture
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            consoleOutput.innerHTML += args.join(' ') + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        console.log('=== IMPORT VALIDATION TESTING TOOL ===');
        
        function checkButtonState() {
            console.log('üîç Checking Start Import button state...');
            
            try {
                // Try multiple ways to access the button
                let button = document.getElementById('start-import');
                if (!button && window.parent && window.parent !== window) {
                    button = window.parent.document.getElementById('start-import');
                }
                if (!button && window.opener) {
                    button = window.opener.document.getElementById('start-import');
                }
                
                if (button) {
                    console.log('‚úÖ Found Start Import button!');
                    console.log('- Disabled:', button.disabled);
                    console.log('- Classes:', button.className);
                    console.log('- Display:', window.getComputedStyle(button).display);
                    console.log('- Visibility:', window.getComputedStyle(button).visibility);
                    console.log('- Text content:', button.textContent.trim());
                } else {
                    console.log('‚ùå Start Import button not found');
                }
                
            } catch (error) {
                console.error('‚ùå Error checking button state:', error);
            }
        }
        
        function checkFileSelection() {
            console.log('üîç Checking file selection state...');
            
            try {
                let fileInput = document.getElementById('csv-file');
                if (!fileInput && window.parent && window.parent !== window) {
                    fileInput = window.parent.document.getElementById('csv-file');
                }
                if (!fileInput && window.opener) {
                    fileInput = window.opener.document.getElementById('csv-file');
                }
                
                if (fileInput) {
                    console.log('‚úÖ Found file input!');
                    console.log('- Files selected:', fileInput.files.length);
                    console.log('- Value:', fileInput.value);
                    if (fileInput.files.length > 0) {
                        console.log('- File name:', fileInput.files[0].name);
                        console.log('- File size:', fileInput.files[0].size);
                    }
                } else {
                    console.log('‚ùå File input not found');
                }
                
            } catch (error) {
                console.error('‚ùå Error checking file selection:', error);
            }
        }
        
        function checkPopulationSelection() {
            console.log('üîç Checking population selection state...');
            
            try {
                let populationSelect = document.getElementById('import-population-select');
                if (!populationSelect && window.parent && window.parent !== window) {
                    populationSelect = window.parent.document.getElementById('import-population-select');
                }
                if (!populationSelect && window.opener) {
                    populationSelect = window.opener.document.getElementById('import-population-select');
                }
                
                if (populationSelect) {
                    console.log('‚úÖ Found population select!');
                    console.log('- Selected value:', populationSelect.value);
                    console.log('- Selected index:', populationSelect.selectedIndex);
                    console.log('- Options count:', populationSelect.options.length);
                    for (let i = 0; i < populationSelect.options.length; i++) {
                        console.log(`  Option ${i}: "${populationSelect.options[i].value}" - "${populationSelect.options[i].text}"`);
                    }
                } else {
                    console.log('‚ùå Population select not found');
                }
                
            } catch (error) {
                console.error('‚ùå Error checking population selection:', error);
            }
        }
        
        function triggerValidation() {
            console.log('üîÑ Attempting to trigger validation function...');
            
            try {
                // Try to access the main app's validation function
                if (window.parent && window.parent !== window) {
                    if (window.parent.app && window.parent.app.subsystems && window.parent.app.subsystems.import) {
                        console.log('‚úÖ Found import subsystem in parent window');
                        if (window.parent.app.subsystems.import.validateAndUpdateButtonState) {
                            console.log('üîÑ Calling validateAndUpdateButtonState...');
                            window.parent.app.subsystems.import.validateAndUpdateButtonState();
                            console.log('‚úÖ Validation function called');
                        } else {
                            console.log('‚ùå validateAndUpdateButtonState method not found');
                        }
                    } else {
                        console.log('‚ùå Import subsystem not found in parent window');
                    }
                }
                
                // Try opener window
                if (window.opener) {
                    if (window.opener.app && window.opener.app.subsystems && window.opener.app.subsystems.import) {
                        console.log('‚úÖ Found import subsystem in opener window');
                        if (window.opener.app.subsystems.import.validateAndUpdateButtonState) {
                            console.log('üîÑ Calling validateAndUpdateButtonState...');
                            window.opener.app.subsystems.import.validateAndUpdateButtonState();
                            console.log('‚úÖ Validation function called');
                        }
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error triggering validation:', error);
            }
        }
        
        function simulateFileSelect() {
            console.log('üîÑ Simulating file selection...');
            
            try {
                let fileInput = document.getElementById('csv-file');
                if (!fileInput && window.parent && window.parent !== window) {
                    fileInput = window.parent.document.getElementById('csv-file');
                }
                if (!fileInput && window.opener) {
                    fileInput = window.opener.document.getElementById('csv-file');
                }
                
                if (fileInput) {
                    // Create a mock file
                    const mockFile = new File(['email,firstName,lastName\ntest@example.com,Test,User'], 'test-users.csv', {
                        type: 'text/csv'
                    });
                    
                    // Create a FileList-like object
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(mockFile);
                    fileInput.files = dataTransfer.files;
                    
                    // Trigger change event
                    const changeEvent = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(changeEvent);
                    
                    console.log('‚úÖ Simulated file selection and triggered change event');
                    console.log('- Mock file name:', mockFile.name);
                    console.log('- Mock file size:', mockFile.size);
                } else {
                    console.log('‚ùå File input not found for simulation');
                }
                
            } catch (error) {
                console.error('‚ùå Error simulating file selection:', error);
            }
        }
        
        function simulatePopulationSelect() {
            console.log('üîÑ Simulating population selection...');
            
            try {
                let populationSelect = document.getElementById('import-population-select');
                if (!populationSelect && window.parent && window.parent !== window) {
                    populationSelect = window.parent.document.getElementById('import-population-select');
                }
                if (!populationSelect && window.opener) {
                    populationSelect = window.opener.document.getElementById('import-population-select');
                }
                
                if (populationSelect && populationSelect.options.length > 1) {
                    // Select the first non-empty option
                    populationSelect.selectedIndex = 1;
                    populationSelect.value = populationSelect.options[1].value;
                    
                    // Trigger change event
                    const changeEvent = new Event('change', { bubbles: true });
                    populationSelect.dispatchEvent(changeEvent);
                    
                    console.log('‚úÖ Simulated population selection and triggered change event');
                    console.log('- Selected value:', populationSelect.value);
                    console.log('- Selected text:', populationSelect.options[populationSelect.selectedIndex].text);
                } else {
                    console.log('‚ùå Population select not found or no options available');
                }
                
            } catch (error) {
                console.error('‚ùå Error simulating population selection:', error);
            }
        }
        
        function simulateBothSelections() {
            console.log('üîÑ Simulating both file and population selection...');
            simulateFileSelect();
            setTimeout(() => {
                simulatePopulationSelect();
                setTimeout(() => {
                    triggerValidation();
                }, 500);
            }, 500);
        }
        
        function clearSelections() {
            console.log('üîÑ Clearing all selections...');
            
            try {
                // Clear file selection
                let fileInput = document.getElementById('csv-file');
                if (!fileInput && window.parent && window.parent !== window) {
                    fileInput = window.parent.document.getElementById('csv-file');
                }
                if (!fileInput && window.opener) {
                    fileInput = window.opener.document.getElementById('csv-file');
                }
                
                if (fileInput) {
                    fileInput.value = '';
                    const changeEvent = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(changeEvent);
                }
                
                // Clear population selection
                let populationSelect = document.getElementById('import-population-select');
                if (!populationSelect && window.parent && window.parent !== window) {
                    populationSelect = window.parent.document.getElementById('import-population-select');
                }
                if (!populationSelect && window.opener) {
                    populationSelect = window.opener.document.getElementById('import-population-select');
                }
                
                if (populationSelect) {
                    populationSelect.selectedIndex = 0;
                    const changeEvent = new Event('change', { bubbles: true });
                    populationSelect.dispatchEvent(changeEvent);
                }
                
                console.log('‚úÖ Cleared all selections');
                
                setTimeout(() => {
                    triggerValidation();
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error clearing selections:', error);
            }
        }
        
        function accessMainAppElements() {
            console.log('üîç Accessing main app elements...');
            
            try {
                // Check current window
                console.log('Current window elements:');
                console.log('- start-import button:', !!document.getElementById('start-import'));
                console.log('- csv-file input:', !!document.getElementById('csv-file'));
                console.log('- import-population-select:', !!document.getElementById('import-population-select'));
                
                // Check parent window
                if (window.parent && window.parent !== window) {
                    console.log('Parent window elements:');
                    console.log('- start-import button:', !!window.parent.document.getElementById('start-import'));
                    console.log('- csv-file input:', !!window.parent.document.getElementById('csv-file'));
                    console.log('- import-population-select:', !!window.parent.document.getElementById('import-population-select'));
                    
                    // Check for app object
                    console.log('- app object:', !!window.parent.app);
                    if (window.parent.app) {
                        console.log('- subsystems:', !!window.parent.app.subsystems);
                        if (window.parent.app.subsystems) {
                            console.log('- import subsystem:', !!window.parent.app.subsystems.import);
                            console.log('- importManager subsystem:', !!window.parent.app.subsystems.importManager);
                        }
                    }
                }
                
                // Check opener window
                if (window.opener) {
                    console.log('Opener window elements:');
                    console.log('- start-import button:', !!window.opener.document.getElementById('start-import'));
                    console.log('- csv-file input:', !!window.opener.document.getElementById('csv-file'));
                    console.log('- import-population-select:', !!window.opener.document.getElementById('import-population-select'));
                }
                
            } catch (error) {
                console.error('‚ùå Error accessing main app elements:', error);
            }
        }
        
        function injectValidationTest() {
            console.log('üîÑ Injecting validation test into main app...');
            
            try {
                const testScript = `
                    console.log('üß™ VALIDATION TEST INJECTED');
                    
                    // Check if elements exist
                    const startBtn = document.getElementById('start-import');
                    const fileInput = document.getElementById('csv-file');
                    const populationSelect = document.getElementById('import-population-select');
                    
                    console.log('Elements found:');
                    console.log('- Start button:', !!startBtn);
                    console.log('- File input:', !!fileInput);
                    console.log('- Population select:', !!populationSelect);
                    
                    if (startBtn) {
                        console.log('Start button state:');
                        console.log('- Disabled:', startBtn.disabled);
                        console.log('- Classes:', startBtn.className);
                    }
                    
                    // Try to find and call validation function
                    if (window.app && window.app.subsystems) {
                        console.log('App subsystems available:', Object.keys(window.app.subsystems));
                        
                        if (window.app.subsystems.import && window.app.subsystems.import.validateAndUpdateButtonState) {
                            console.log('üîÑ Calling validateAndUpdateButtonState...');
                            window.app.subsystems.import.validateAndUpdateButtonState();
                        } else if (window.app.subsystems.importManager && window.app.subsystems.importManager.validateAndUpdateButtonState) {
                            console.log('üîÑ Calling importManager validateAndUpdateButtonState...');
                            window.app.subsystems.importManager.validateAndUpdateButtonState();
                        } else {
                            console.log('‚ùå Validation function not found in subsystems');
                        }
                    } else {
                        console.log('‚ùå App or subsystems not found');
                    }
                `;
                
                // Try to inject into parent window
                if (window.parent && window.parent !== window) {
                    const script = window.parent.document.createElement('script');
                    script.textContent = testScript;
                    window.parent.document.head.appendChild(script);
                    console.log('‚úÖ Test script injected into parent window');
                }
                
                // Try to inject into opener window
                if (window.opener) {
                    const script = window.opener.document.createElement('script');
                    script.textContent = testScript;
                    window.opener.document.head.appendChild(script);
                    console.log('‚úÖ Test script injected into opener window');
                }
                
            } catch (error) {
                console.error('‚ùå Error injecting validation test:', error);
            }
        }
        
        // Auto-run initial checks
        setTimeout(() => {
            console.log('üîÑ Running initial checks...');
            accessMainAppElements();
        }, 1000);
    </script>
</body>
</html>
