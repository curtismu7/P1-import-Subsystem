<!--
  Swagger API Tool - Professional API Documentation Interface
  ----------------------------------------------------------
  Enhanced Swagger interface with comprehensive token management and high-contrast design.
  
  Key Features:
  - Professional "Swagger API Tool" branding
  - High-contrast, accessible color scheme
  - Secure PingOne worker token retrieval and status display
  - Integration with AuthManagementSubsystem and TokenManager
  - Real-time token validation and expiration tracking
  - Enhanced UX with modern design patterns
  - HTTPS-secured API communication
  - Comprehensive error handling and user feedback
  
  Architecture:
  - Uses subsystem architecture for authentication and settings
  - Event-driven coordination via EventBus patterns
  - ES module patterns with secure credential handling
  - Professional UI aligned with Ping Identity design system
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Swagger API Tool - PingOne Import Tool</title>
  
  <!-- Swagger UI Styles -->
  <link rel="stylesheet" type="text/css" href="/swagger/swagger-ui.css" />
  <link rel="icon" href="/favicon.ico" />
  
  <!-- Modern Application Styles -->
  <!-- Use existing public CSS files -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/pingone-ui-custom.css">
  <style>
    /* High-Contrast Light Theme Swagger API Tool Styles */
    body { 
      margin: 0; 
      background: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #000000;
      line-height: 1.6;
    }
    
    /* Override Swagger UI dark theme */
    .swagger-ui {
      background: #ffffff !important;
      color: #000000 !important;
    }
    
    .swagger-ui .scheme-container {
      background: #f8f9fa !important;
      border: 2px solid #dee2e6 !important;
    }
    
    .swagger-ui .opblock {
      background: #ffffff !important;
      border: 2px solid #dee2e6 !important;
      color: #000000 !important;
    }
    
    .swagger-ui .opblock .opblock-summary {
      background: #f8f9fa !important;
      color: #000000 !important;
    }
    
    .swagger-ui .opblock.opblock-post {
      border-color: #28a745 !important;
    }
    
    .swagger-ui .opblock.opblock-post .opblock-summary {
      border-color: #28a745 !important;
      background: #d4edda !important;
    }
    
    .swagger-ui .opblock.opblock-get {
      border-color: #007bff !important;
    }
    
    .swagger-ui .opblock.opblock-get .opblock-summary {
      border-color: #007bff !important;
      background: #d1ecf1 !important;
    }
    
    .swagger-ui .opblock.opblock-put {
      border-color: #fd7e14 !important;
    }
    
    .swagger-ui .opblock.opblock-put .opblock-summary {
      border-color: #fd7e14 !important;
      background: #ffeaa7 !important;
    }
    
    .swagger-ui .opblock.opblock-delete {
      border-color: #dc3545 !important;
    }
    
    .swagger-ui .opblock.opblock-delete .opblock-summary {
      border-color: #dc3545 !important;
      background: #f8d7da !important;
    }
    
    .swagger-ui .parameters-col_description p,
    .swagger-ui .parameters-col_name .parameter__name,
    .swagger-ui .parameter__type {
      color: #000000 !important;
    }
    
    .swagger-ui .model {
      background: #f8f9fa !important;
      color: #000000 !important;
    }
    
    .swagger-ui .model-title {
      color: #000000 !important;
    }
    
    .swagger-ui .prop-type {
      color: #007bff !important;
    }
    
    .swagger-ui .prop-format {
      color: #6c757d !important;
    }
    
    #swagger-ui { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 20px;
      background: #ffffff;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      margin-top: 20px;
      margin-bottom: 20px;
    }
    
    /* Professional Header Styles - High Contrast */
    .swagger-header {
      background: #f8f9fa;
      color: #212529;
      padding: 24px;
      border-radius: 8px 8px 0 0;
      margin: -20px -20px 20px -20px;
      text-align: center;
      border-bottom: 3px solid #007bff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .swagger-header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      color: #212529;
    }
    
    .swagger-header p {
      margin: 8px 0 0 0;
      color: #6c757d;
      font-size: 16px;
      font-weight: 400;
    }
    
    /* Token Management Panel Styles */
    .token-management-panel {
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .token-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .token-panel-header h3 {
      margin: 0;
      color: #212529;
      font-size: 18px;
      font-weight: 600;
    }
    
    .token-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 8px 16px;
      border: 2px solid transparent;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-primary {
      background: #007bff;
      color: #ffffff;
      border-color: #007bff;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #0056b3;
      border-color: #0056b3;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: #ffffff;
      border-color: #6c757d;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #545b62;
      border-color: #545b62;
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: #dc3545;
      color: #ffffff;
      border-color: #dc3545;
    }
    
    .btn-danger:hover:not(:disabled) {
      background: #c82333;
      border-color: #c82333;
      transform: translateY(-1px);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .token-status-display {
      background: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 16px;
      margin: 16px auto; /* center */
      width: 50%;
      max-width: 560px;
      min-width: 320px;
    }
    
    .token-status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .token-status-row:last-child {
      margin-bottom: 0;
    }
    
    .token-label {
      font-weight: 600;
      color: #495057;
      font-size: 14px;
    }
    
    .token-status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-valid {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-expired {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-unknown {
      background: #e2e3e5;
      color: #383d41;
      border: 1px solid #d6d8db;
    }
    
    .token-expiry-time, .token-remaining-time {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #6c757d;
      font-weight: 500;
    }
    
    .token-error-display {
      background: #f8d7da;
      border: 2px solid #f5c6cb;
      border-radius: 6px;
      padding: 12px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .error-icon {
      font-size: 20px;
      flex-shrink: 0;
    }
    
    .error-message {
      flex: 1;
      color: #721c24;
      font-size: 14px;
    }
    
    /* Enhanced Population Selector - High Contrast */
    .population-selector {
      background: #ffffff;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    
    .population-selector:hover {
      border-color: #007bff;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
    }
    
    .population-selector h3 {
      margin: 0 0 12px 0;
      color: #212529;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .population-selector select {
      width: 280px;
      padding: 12px 16px;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      font-size: 16px;
      background: #ffffff;
      color: #212529;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .selector-inline {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      max-width: 420px;
    }
    
    .population-selector select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
      background: #ffffff;
    }
    
    .population-info {
      margin-top: 12px;
      font-size: 14px;
      color: #6c757d;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    
    .loading-populations {
      color: #007bff;
      font-style: italic;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    
    .error-populations {
      color: #dc3545;
      font-size: 14px;
      font-weight: 600;
      background: #f8d7da;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #f5c6cb;
    }
    
    /* Status Indicators - High Contrast */
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 2s infinite;
      border: 2px solid #ffffff;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
    }
    
    .status-success { background-color: #28a745; }
    .status-warning { background-color: #ffc107; }
    .status-error { background-color: #dc3545; }
    .status-info { background-color: #17a2b8; }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      #swagger-ui {
        margin: 10px;
        padding: 15px;
      }
      
      .swagger-header {
        margin: -15px -15px 15px -15px;
        padding: 20px;
      }
      
      .swagger-header h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <!-- Professional Swagger API Tool Header -->
  <div class="swagger-header">
    <div style="position: relative;">
          <div class="swagger-version-widget" style="text-align: center; margin-bottom: 10px; background-color: red; color: black; padding: 5px 10px; border-radius: 5px; font-family: monospace; font-size: 14px; font-weight: bold; display: inline-block;">v7.3.0</div>
      <h1>üìö Swagger API Tool</h1>
      <p>Professional API documentation and testing interface for PingOne Import Tool</p>
      <div id="status-toast" style="display:none; margin-top:8px; font-weight:600;"></div>
    </div>
  </div>

  <!-- Secure Token Management Panel -->
  <div class="token-management-panel">
    <div class="token-panel-header">
      <h3>üîê PingOne Worker Token Management</h3>
      <div class="token-actions">
        <button id="retrieve-token-btn" class="btn btn-primary">Retrieve Token</button>
        <button id="refresh-token-btn" class="btn btn-secondary" disabled>Refresh Token</button>
        <button id="clear-token-btn" class="btn btn-danger" disabled>Clear Token</button>
      </div>
    </div>
    
    <div class="token-status-display">
      <div class="token-status-row">
        <span class="token-label">Status:</span>
        <span id="token-status-indicator" class="status-indicator status-info" aria-hidden="true" style="margin-right:8px;"></span>
        <span id="token-status" class="token-status-badge status-unknown">Unknown</span>
      </div>
      <div class="token-status-row">
        <span class="token-label">Expires:</span>
        <span id="token-expiry" class="token-expiry-time">Not available</span>
      </div>
      <div class="token-status-row">
        <span class="token-label">Time Remaining:</span>
        <span id="token-remaining" class="token-remaining-time">Not available</span>
      </div>
    </div>
    
    <div id="token-error-display" class="token-error-display" style="display: none;">
      <div class="error-icon">‚ö†Ô∏è</div>
      <div class="error-message">
        <strong>Token Error:</strong>
        <span id="token-error-message">No error</span>
      </div>
    </div>
  </div>

  <!-- Enhanced Population Selector -->
  <div class="population-selector" id="population-selector-container">
    <h3>
      <span>üë•</span>
      <span>Population Selection</span>
      <span class="status-indicator status-info" id="population-status-indicator"></span>
    </h3>
    <label for="population-selector" id="population-selector-label" style="font-size: 14px; font-weight: 500; display: block; margin-bottom: 8px; color: #6c757d;">
      Select a population for API operations <span style="color: #dc3545; font-weight: 600;">(Required)</span>
    </label>
    <div class="selector-inline">
      <select id="population-selector">
        <option value="">üîÑ Loading populations from subsystem...</option>
      </select>
      <button id="refresh-populations-btn" class="btn btn-primary" title="Refresh populations">
        <span class="mdi mdi-refresh"></span> Refresh
      </button>
    </div>
    <div class="population-info">
      <span id="population-status" class="loading-populations">
        <div class="loading-spinner"></div>
        <span>Loading populations via PopulationSubsystem...</span>
      </span>
      <span id="selected-population-details" style="display:none;"></span>
    </div>
  </div>
  
  <!-- Swagger UI Container -->
  <div id="swagger-ui"></div>
  
  <!-- Modern JavaScript with Subsystem Integration -->
  <script src="/swagger/swagger-ui-bundle.js"></script>
  <script src="/swagger/swagger-ui-standalone-preset.js"></script>
  <script src="/swagger/swagger-initializer.js"></script>
  <script>
    /**
     * Modern Swagger UI Integration with Subsystem Architecture
     * This script enhances the base swagger-initializer.js with additional
     * population management and legacy compatibility features.
     */
    
    // Modern subsystem integration variables
    let selectedPopulationId = null;
    let populations = [];
    let subsystemsReady = false;
    
    // Token management variables
    let currentToken = null;
    let tokenExpiryTime = null;
    let tokenUpdateInterval = null;
    let tokenStatusRefreshInterval = null; // 5-minute refresh timer
    let tokenStatusElements = {
      status: document.getElementById('token-status'),
      expiry: document.getElementById('token-expiry'),
      remaining: document.getElementById('token-remaining'),
      errorDisplay: document.getElementById('token-error-display'),
      errorMessage: document.getElementById('token-error-message')
    };

    /**
     * Secure Token Management Functions
     */

    function getTokenFromLocalStorage() {
      try {
        // Preferred cache format
        const cache = localStorage.getItem('pingone_token_cache');
        if (cache) {
          const obj = JSON.parse(cache);
          const exp = obj.expiresAt ? new Date(obj.expiresAt) : null;
          return { token: obj.token, expiresAt: exp };
        }
        // Legacy token storage
        const raw = localStorage.getItem('pingone_token');
        if (raw) {
          const obj = JSON.parse(raw);
          // Try companion expiry key if present
          const expiresKey = localStorage.getItem('pingone_token_expires');
          const exp = expiresKey ? new Date(expiresKey) : null;
          return { token: obj.access_token, expiresAt: exp };
        }
        // Worker token simple
        const worker = localStorage.getItem('pingone_worker_token');
        if (worker) {
          return { token: worker, expiresAt: null };
        }
        const access = localStorage.getItem('accessToken');
        if (access) {
          return { token: access, expiresAt: null };
        }
      } catch (e) {
        console.log('Local token read failed', e.message);
      }
      return null;
    }
    
    /**
     * Retrieve PingOne worker token using secure HTTPS communication
     */
    async function retrieveWorkerToken() {
      const retrieveBtn = document.getElementById('retrieve-token-btn');
      const refreshBtn = document.getElementById('refresh-token-btn');
      const clearBtn = document.getElementById('clear-token-btn');
      
      try {
        // Update UI to show loading state
        retrieveBtn.disabled = true;
        retrieveBtn.textContent = 'üîÑ Retrieving...';
        hideTokenError();
        
        console.log('üîê Attempting to read token from localStorage...');

        const local = getTokenFromLocalStorage();
        if (local && local.token) {
          // Use local token immediately
          currentToken = local.token;
          tokenExpiryTime = local.expiresAt || null;
          // If we have a future expiry, mark valid; if missing/expired, verify with server
          if (tokenExpiryTime && tokenExpiryTime > new Date()) {
            updateTokenStatus('valid');
            updateTokenExpiry(tokenExpiryTime);
            tokenStatusElements.remaining.textContent = 'Calculating‚Ä¶';
            startTokenMonitoring();
          } else {
            const info = await fetchServerTokenInfo();
            if (info && info.isValid) {
              tokenExpiryTime = info.expiresAt ? new Date(info.expiresAt) : null;
              updateTokenStatus('valid');
              updateTokenExpiry(tokenExpiryTime);
              tokenStatusElements.remaining.textContent = tokenExpiryTime ? 'Calculating‚Ä¶' : 'Unknown';
              if (tokenExpiryTime) startTokenMonitoring();
            } else {
              updateTokenStatus('expired');
              updateTokenExpiry(null);
            }
          }
          refreshBtn.disabled = false;
          clearBtn.disabled = false;

          // Dispatch event for Swagger UI integration
          window.dispatchEvent(new CustomEvent('worker-token-updated', {
            detail: { token: currentToken, expiresAt: tokenExpiryTime }
          }));
          console.log('‚úÖ Using token from localStorage');
          return; // Done
        }

        console.log('üîê No local token found; requesting from API...');

        // Make secure HTTPS request to refresh token endpoint (existing subsystem)
        const response = await fetch('/api/pingone/get-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin'
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Network error' }));
          throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
        }

        const tokenData = await response.json();
        const payload = tokenData && (tokenData.data || tokenData.message || tokenData) || {};
        const accessToken = payload.access_token || payload.token || payload.workerToken || payload.accessToken;
        const expiresInSec = payload.expires_in || payload.expiresIn || 3600;
        if (!accessToken) {
          throw new Error(payload.error || 'Invalid token response');
        }

        // Use API token
        currentToken = accessToken;
        const expiresInMs = expiresInSec * 1000;
        tokenExpiryTime = new Date(Date.now() + expiresInMs);
        
        // Update UI with success state
        updateTokenStatus('valid');
        updateTokenExpiry(tokenExpiryTime);
        tokenStatusElements.remaining.textContent = 'Calculating‚Ä¶';
        startTokenMonitoring();
        
        // Enable refresh and clear buttons
        refreshBtn.disabled = false;
        clearBtn.disabled = false;
        
        // monitoring started above
        
        console.log('‚úÖ Worker token retrieved successfully');
        
        // Dispatch event for Swagger UI integration
        window.dispatchEvent(new CustomEvent('worker-token-updated', {
          detail: { token: currentToken, expiresAt: tokenExpiryTime }
        }));
        
      } catch (error) {
        console.error('‚ùå Failed to retrieve worker token:', error);
        showTokenError(error.message);
        updateTokenStatus('error');
        
        // Reset token state
        currentToken = null;
        tokenExpiryTime = null;
        refreshBtn.disabled = true;
        clearBtn.disabled = true;
        
      } finally {
        // Reset retrieve button
        retrieveBtn.disabled = false;
        retrieveBtn.textContent = 'Retrieve Token';
      }
    }

    /**
     * Ask server for current token status/expiry
     */
    async function fetchServerTokenInfo() {
      try {
        const response = await fetch('/api/auth/token-info', { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
        if (!response.ok) return null;
        const data = await response.json();
        const tokenInfo = data?.tokenInfo || data?.message?.tokenInfo || data?.data?.message?.tokenInfo || data?.data?.tokenInfo;
        if (data?.success && tokenInfo) {
          return {
            isValid: !!(tokenInfo.isValid ?? tokenInfo.hasValidToken),
            expiresAt: tokenInfo.expiresAt || tokenInfo.expires_at || null,
            timeLeft: tokenInfo.expiresIn || tokenInfo.timeLeft || 0
          };
        }
      } catch (e) { /* ignore */ }
      return null;
    }
    
    /**
     * Refresh existing worker token
     */
    async function refreshWorkerToken() {
      if (!currentToken) {
        showTokenError('No token to refresh. Please retrieve a new token.');
        return;
      }
      
      const refreshBtn = document.getElementById('refresh-token-btn');
      
      try {
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'üîÑ Refreshing...';
        hideTokenError();
        
        console.log('üîÑ Refreshing worker token...');
        
        const response = await fetch('/api/pingone/get-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin'
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Network error' }));
          throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        const tokenData = await response.json();
        const payload = tokenData && (tokenData.data || tokenData.message || tokenData) || {};
        const accessToken = payload.access_token || payload.token || payload.workerToken || payload.accessToken;
        const expiresInSec = payload.expires_in || payload.expiresIn || 3600;
        if (!accessToken) {
          throw new Error(payload.error || 'Invalid refresh response');
        }
        
        // Update token data
        currentToken = accessToken;
        // Calculate expiry time from expires_in (seconds)
        const expiresInMs = (expiresInSec) * 1000;
        tokenExpiryTime = new Date(Date.now() + expiresInMs);
        
        // Update UI
        updateTokenStatus('valid');
        updateTokenExpiry(tokenExpiryTime);
        
        console.log('‚úÖ Worker token refreshed successfully');
        
        // Dispatch event for Swagger UI integration
        window.dispatchEvent(new CustomEvent('worker-token-updated', {
          detail: { token: currentToken, expiresAt: tokenExpiryTime }
        }));
        
      } catch (error) {
        console.error('‚ùå Failed to refresh worker token:', error);
        showTokenError(error.message);
        updateTokenStatus('error');
        
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'Refresh Token';
      }
    }
    
    /**
     * Clear current worker token
     */
    async function clearWorkerToken() {
      console.log('üóëÔ∏è Clearing worker token...');
      
      try {
        // Call the clear credentials endpoint
        const response = await fetch('/api/auth/clear-credentials', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin'
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Network error' }));
          throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        console.log('‚úÖ Server credentials cleared');
      } catch (error) {
        console.warn('‚ö†Ô∏è Could not clear server credentials:', error.message);
        // Continue with client-side cleanup even if server clear fails
      }
      
      // Clear token data
      currentToken = null;
      tokenExpiryTime = null;
      
      // Stop monitoring
      stopTokenMonitoring();
      
      // Update UI
      updateTokenStatus('unknown');
      tokenStatusElements.expiry.textContent = 'Not available';
      tokenStatusElements.remaining.textContent = 'Not available';
      hideTokenError();
      
      // Disable buttons
      document.getElementById('refresh-token-btn').disabled = true;
      document.getElementById('clear-token-btn').disabled = true;
      
      console.log('‚úÖ Worker token cleared');
      
      // Dispatch event for Swagger UI integration
      window.dispatchEvent(new CustomEvent('worker-token-cleared'));
    }
    
    /**
     * Update token status display
     */
    function updateTokenStatus(status) {
      const statusElement = tokenStatusElements.status;
      const indicatorEl = document.getElementById('token-status-indicator');
      
      // Remove existing status classes
      statusElement.classList.remove('status-valid', 'status-expired', 'status-error', 'status-unknown');
      
      // Add new status class and update text
      switch (status) {
        case 'valid':
          statusElement.classList.add('status-valid');
          statusElement.textContent = 'Valid';
          if (indicatorEl) indicatorEl.className = 'status-indicator status-success';
          break;
        case 'expired':
          statusElement.classList.add('status-expired');
          statusElement.textContent = 'Expired';
          if (indicatorEl) indicatorEl.className = 'status-indicator status-error';
          break;
        case 'error':
          statusElement.classList.add('status-error');
          statusElement.textContent = 'Error';
          if (indicatorEl) indicatorEl.className = 'status-indicator status-error';
          break;
        default:
          statusElement.classList.add('status-unknown');
          statusElement.textContent = 'Unknown';
          if (indicatorEl) indicatorEl.className = 'status-indicator status-info';
      }
    }
    
    /**
     * Update token expiry display
     */
    function updateTokenExpiry(expiryTime) {
      if (!expiryTime) {
        tokenStatusElements.expiry.textContent = 'Not available';
        return;
      }
      
      const formattedTime = expiryTime.toLocaleString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
      
      tokenStatusElements.expiry.textContent = formattedTime;
    }
    
    /**
     * Update remaining time display
     */
    function updateRemainingTime() {
      if (!tokenExpiryTime) {
        tokenStatusElements.remaining.textContent = 'Not available';
        return;
      }
      
      const now = new Date();
      const remaining = tokenExpiryTime.getTime() - now.getTime();
      
      if (remaining <= 0) {
        tokenStatusElements.remaining.textContent = 'Expired';
        updateTokenStatus('expired');
        document.getElementById('refresh-token-btn').disabled = true;
        return;
      }
      
      // Convert to human-readable format
      const hours = Math.floor(remaining / (1000 * 60 * 60));
      const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
      
      let timeString = '';
      if (hours > 0) timeString += `${hours}h `;
      if (minutes > 0) timeString += `${minutes}m `;
      timeString += `${seconds}s`;
      
      tokenStatusElements.remaining.textContent = timeString;
      
      // Warn if token expires soon (less than 5 minutes)
      if (remaining < 5 * 60 * 1000) {
        tokenStatusElements.remaining.style.color = '#dc3545';
        tokenStatusElements.remaining.style.fontWeight = '700';
      } else {
        tokenStatusElements.remaining.style.color = '#6c757d';
        tokenStatusElements.remaining.style.fontWeight = '500';
      }
    }
    
    /**
     * Start token monitoring interval
     */
    function startTokenMonitoring() {
      stopTokenMonitoring(); // Clear any existing interval
      
      tokenUpdateInterval = setInterval(() => {
        updateRemainingTime();
      }, 1000); // Update every second
    }
    
    /**
     * Stop token monitoring interval
     */
    function stopTokenMonitoring() {
      if (tokenUpdateInterval) {
        clearInterval(tokenUpdateInterval);
        tokenUpdateInterval = null;
      }
    }
    
    /**
     * Show token error message
     */
    function showTokenError(message) {
      tokenStatusElements.errorMessage.textContent = message;
      tokenStatusElements.errorDisplay.style.display = 'flex';
      showToast(message, 'error');
    }
    
    /**
     * Hide token error message
     */
    function hideTokenError() {
      tokenStatusElements.errorDisplay.style.display = 'none';
    }

    function showToast(message, type = 'info') {
      const el = document.getElementById('status-toast');
      if (!el) return;
      el.style.display = 'inline-block';
      el.textContent = message;
      el.style.padding = '6px 10px';
      el.style.borderRadius = '8px';
      el.style.background = type === 'error' ? '#f8d7da' : type === 'success' ? '#d4edda' : '#e2e3e5';
      el.style.color = '#111';
      setTimeout(() => { el.style.display = 'none'; }, 4000);
    }
    
    /**
     * Enhanced population loading using subsystem APIs
     */
    async function loadPopulationsFromSubsystem() {
      const statusEl = document.getElementById('population-status');
      const selectorEl = document.getElementById('population-selector');
      const indicatorEl = document.getElementById('population-status-indicator');
      
      try {
        console.log('üîÑ Loading populations from PopulationSubsystem');
        
        // Update UI to show loading state
        statusEl.innerHTML = `
          <div class="loading-spinner"></div>
          <span>Loading populations via PopulationSubsystem...</span>
        `;
        indicatorEl.className = 'status-indicator status-info';
        
        // Attempt 1: standardized settings endpoint (first source)
        let loaded = false;
        try {
          const settingsResp = await fetch('/api/settings', { cache: 'no-cache' });
          if (settingsResp.ok) {
            const settings = await settingsResp.json().catch(() => ({}));
            const payload = settings && (settings.success ? (settings.data || {}) : settings);
            const fromSettings = payload.populations || payload.populationCache?.populations || payload.data?.populations;
            if (Array.isArray(fromSettings) && fromSettings.length) {
              populations = fromSettings;
              loaded = true;
              console.log('‚úÖ Loaded populations from /api/settings');
            }
          }
        } catch (e) { /* ignore */ }

        // Attempt 2: API /api/populations (robust shapes)
        if (!loaded) {
          const response = await fetch('/api/populations');
          if (response.ok) {
            const result = await response.json();
            let pops = [];
            if (Array.isArray(result)) {
              pops = result;
            } else {
              pops = result.data?.message?.populations ||
                     result.message?.populations ||
                     result.data?.populations ||
                     result.populations || [];
            }
            if (Array.isArray(pops) && pops.length) {
              populations = pops;
              loaded = true;
              console.log('‚úÖ Loaded populations from /api/populations');
            }
          }
        }

        // Attempt 3: API /api/settings populationCache
        if (!loaded) {
          const resp = await fetch('/api/settings', { cache: 'no-cache' });
          if (resp.ok) {
            const result = await resp.json();
            const data = (result && result.data && result.data.data) || result.data || result.message || {};
            const pops = data.populationCache?.populations || data.populations || [];
            if (Array.isArray(pops) && pops.length) {
              populations = pops;
              loaded = true;
              console.log('‚úÖ Loaded populations from /api/settings');
            }
          }
        }
        
        if (loaded) {
          
          // Update selector with populations
          selectorEl.innerHTML = '<option value="">üéØ Select a population...</option>';
          
          populations.forEach(pop => {
            const option = document.createElement('option');
            const id = pop.id || pop.populationId || pop.value || '';
            option.value = id;
            option.textContent = `${pop.name || pop.label || 'Population'} (${id})`;
            selectorEl.appendChild(option);
          });
          
          // Update status
          statusEl.innerHTML = `
            <span class="status-indicator status-success"></span>
            <span>‚úÖ Loaded ${populations.length} populations</span>
          `;
          indicatorEl.className = 'status-indicator status-success';
          
          console.log(`‚úÖ Loaded ${populations.length} populations`);
          
        } else {
          throw new Error('Invalid populations response from subsystem');
        }
        
      } catch (error) {
        console.error('‚ùå Failed to load populations from subsystem:', error);
        
        // Update UI to show error state
        statusEl.innerHTML = `
          <span class="status-indicator status-error"></span>
          <span class="error-populations">‚ùå Failed to load populations: ${error.message}</span>
        `;
        indicatorEl.className = 'status-indicator status-error';
        
        // Set fallback option
        selectorEl.innerHTML = '<option value="">‚ùå Failed to load populations</option>';
      }
    }

    /**
     * Handle population selection with enhanced UI feedback
     */
    function handlePopulationSelection() {
      const selectorEl = document.getElementById('population-selector');
      const detailsEl = document.getElementById('selected-population-details');
      const labelEl = document.getElementById('population-selector-label');
      
      selectedPopulationId = selectorEl.value;
      
      if (selectedPopulationId) {
        const selectedPop = populations.find(p => p.id === selectedPopulationId);
        
        if (selectedPop) {
          // Show selection details
          detailsEl.style.display = 'block';
          detailsEl.innerHTML = `
            <span class="status-indicator status-success"></span>
            <strong>Selected:</strong> ${selectedPop.name} 
            <span style="color: #6c757d;">(ID: ${selectedPop.id})</span>
          `;
          
          // Reset selector styling
          selectorEl.style.border = '2px solid #28a745';
          selectorEl.style.background = 'white';
          labelEl.style.color = '#28a745';
          
          console.log('‚úÖ Population selected:', selectedPop);
          
          // Dispatch event for subsystem integration
          window.dispatchEvent(new CustomEvent('population-selected', {
            detail: { population: selectedPop }
          }));
        }
      } else {
        // Clear selection
        detailsEl.style.display = 'none';
        selectorEl.style.border = '2px solid #e1e5e9';
        selectorEl.style.background = 'white';
        labelEl.style.color = '#6c757d';
        
        console.log('Population selection cleared');
        
        // Dispatch event for subsystem integration
        window.dispatchEvent(new CustomEvent('population-cleared'));
      }
    }

    /**
     * Initialize Swagger API Tool with comprehensive token management
     */
    async function initializeSwaggerAPITool() {
      try {
        console.log('üöÄ Initializing Swagger API Tool with Token Management');
        
        // Initialize token management UI
        initializeTokenManagement();
        
        // Load populations from subsystem
        await loadPopulationsFromSubsystem();
        
        // Setup population selector event handler
        const selectorEl = document.getElementById('population-selector');
        if (selectorEl) {
          selectorEl.addEventListener('change', handlePopulationSelection);
        }

        const refreshBtn = document.getElementById('refresh-populations-btn');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', async () => {
            await loadPopulationsFromSubsystem();
          });
        }
        
        // Setup event listeners for subsystem integration
        window.addEventListener('auth-token-updated', (event) => {
          console.log('üîê Auth token updated from subsystem event');
        });
        
        window.addEventListener('settings-updated', (event) => {
          console.log('‚öôÔ∏è Settings updated from subsystem event');
        });
        
        // Setup Swagger UI token integration
        window.addEventListener('worker-token-updated', (event) => {
          console.log('üîê Worker token updated for Swagger UI integration');
          // Integrate token with Swagger UI if available
          if (window.ui && window.ui.preauthorizeApiKey) {
            window.ui.preauthorizeApiKey('BearerAuth', event.detail.token);
          }
        });
        
        window.addEventListener('worker-token-cleared', () => {
          console.log('üóëÔ∏è Worker token cleared from Swagger UI');
          // Clear token from Swagger UI if available
          if (window.ui && window.ui.preauthorizeApiKey) {
            window.ui.preauthorizeApiKey('BearerAuth', null);
          }
        });
        
        // Start 5-minute token status refresh
        if (tokenStatusRefreshInterval) clearInterval(tokenStatusRefreshInterval);
        tokenStatusRefreshInterval = setInterval(async () => {
          try { await checkExistingToken(); } catch {}
        }, 5 * 60 * 1000);

        // Mark subsystems as ready
        subsystemsReady = true;
        
        console.log('‚úÖ Swagger API Tool initialization complete');
        
      } catch (error) {
        console.error('‚ùå Failed to initialize Swagger API Tool:', error);
      }
    }
    
    /**
     * Initialize token management event handlers
     */
    function initializeTokenManagement() {
      console.log('üîê Initializing token management...');
      
      // Setup button event handlers
      const retrieveBtn = document.getElementById('retrieve-token-btn');
      const refreshBtn = document.getElementById('refresh-token-btn');
      const clearBtn = document.getElementById('clear-token-btn');
      
      if (retrieveBtn) {
        retrieveBtn.addEventListener('click', retrieveWorkerToken);
      }
      
      if (refreshBtn) {
        refreshBtn.addEventListener('click', refreshWorkerToken);
      }
      
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          showToast('Clearing worker token...', 'info');
          clearWorkerToken();
        });
      }
      
      // Initialize token status elements after DOM is ready
      setTimeout(() => {
        tokenStatusElements = {
          status: document.getElementById('token-status'),
          expiry: document.getElementById('token-expiry'),
          remaining: document.getElementById('token-remaining'),
          errorDisplay: document.getElementById('token-error-display'),
          errorMessage: document.getElementById('token-error-message')
        };
        
        // Check for any existing token on page load
        checkExistingToken();
      }, 100);
      
      console.log('‚úÖ Token management initialized');
    }
    
    /**
     * Check for existing token on page load
     */
    async function checkExistingToken() {
      try {
        console.log('üîç Checking for existing worker token...');
        
        const response = await fetch('/api/auth/token-info', {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin'
        });
        
        if (response.ok) {
          const tokenData = await response.json();
          const tokenInfo = tokenData?.tokenInfo || tokenData?.message?.tokenInfo || tokenData?.data?.message?.tokenInfo || tokenData?.data?.tokenInfo;
          
          if (tokenData.success && tokenInfo && (tokenInfo.expiresAt || tokenInfo.expires_at)) {
            const expiryEpoch = tokenInfo.expiresAt || tokenInfo.expires_at;
            const expiryTime = new Date(expiryEpoch);
            
            if (expiryTime > new Date()) {
              // Token is still valid
              currentToken = 'existing'; // Don't store actual token for security
              tokenExpiryTime = expiryTime;
              
              updateTokenStatus('valid');
              updateTokenExpiry(tokenExpiryTime);
              
              // Enable refresh and clear buttons
              document.getElementById('refresh-token-btn').disabled = false;
              document.getElementById('clear-token-btn').disabled = false;
              
              // Start monitoring
              startTokenMonitoring();
              
              console.log('‚úÖ Found existing valid token');
            } else {
              console.log('‚ö†Ô∏è Found expired token');
              updateTokenStatus('expired');
            }
          } else {
            console.log('‚ÑπÔ∏è No existing token found');
          }
        }
      } catch (error) {
        console.log('‚ÑπÔ∏è Could not check existing token:', error.message);
      }
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeSwaggerAPITool);
    } else {
      initializeSwaggerAPITool();
    }
    
    // Note: The main Swagger UI initialization is handled by swagger-initializer.js
    // This script provides comprehensive token management and enhanced population features
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      stopTokenMonitoring();
      if (tokenStatusRefreshInterval) clearInterval(tokenStatusRefreshInterval);
    });
    
    // Handle visibility changes to pause/resume monitoring
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopTokenMonitoring();
      } else if (currentToken && tokenExpiryTime) {
        startTokenMonitoring();
      }
    });
  </script>
  
  <!-- Footer -->
  <footer class="app-footer" style="text-align: center; padding: 20px; color: #6c757d; font-size: 14px;">
    <div class="footer-content">
      <div class="footer-logo" style="margin-bottom: 10px;">
        <img src="/ping-identity-logo.svg" alt="Ping Identity Logo" height="28" width="auto" loading="lazy" />
      </div>
      <div class="footer-text">
        <span>&copy; 2025 Ping Identity. All rights reserved.</span>
        <br>
        <span style="font-size: 12px; opacity: 0.8;">üöÄ Powered by Modern Subsystem Architecture</span>
      </div>
    </div>
  </footer>
</body>
</html>
